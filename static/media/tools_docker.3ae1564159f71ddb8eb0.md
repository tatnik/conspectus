# DOCKER

\- это платформа, позволяющая упаковать в контейнер приложение со всем окружением и зависимостями, а затем доставить и запустить его в целевой системе

приложение в контейнере изолируется от операционной системы и других приложений

разработан в 2008 г., в 2013 его код стал открытым

Docker изначально создавался под Linux. Поэтому на Windows и macOS запускают виртуальную машину с Linux, а поверх неё — Docker. В macOS используют VirtualBox, а в Windows — Hyper-V

## Компоненты Docker:

- **Docker host** - операционная система, на которую устанавливается Docker

- **Docker daemon** - служба, которая управляет Docker-объектами (сетями, хранилищами, образами, контейнерами)

- **Docker client** - консольный клиент для взаимодействия с _Docker daemon_ и для управления контейнерами

- **Docker image** - неизменяемый образ, из которого разворачивается контейнер. Представляет из себя переносимый, легкий и исполняемый пакет, содержащий все необходимое для запуска приложения: код, время выполнения, системные инструменты, библиотеки и настройки. Образы создаются на основе базовых образов - предварительно сконфигурированных сред ОС, которые служат основой для контейнерного приложения.

- **Docker container** - развернутое и запущенное приложение. При запуске контейнер оборачивает приложение и его зависимости в изолированную и согласованную среду. Контейнеры можно создавать, запускать, останавливать и удалять по мере необходимости, что повышает переносимость приложений и упрощает тестирование и развертывание новых версий программного обеспечения.

- **Docker Registry** - реестр образов — это централизованное место для хранения и распространения образов контейнеров. Он может быть как публичным, так и приватным. _Docker Hub_ — это публичный реестр, который является реестром по умолчанию. Это глобальная торговая площадка для хранения и распространения образов [Перейти](https://hub.docker.com/)

- **Dockerfile** - файл-инструкция для сборки образа. В нем указываются базовый образ, зависимости, код приложения, системные конфигурации и другие требования для запуска приложения в контейнере [Подробнее...](https://docs.docker.com/reference/dockerfile/)

- **Docker Compose** - инструмент для управления несколькими контейнерами, позволяет создавать и конфигуровать контейнеры

- **Docker Desktop** - GUI-клиент, который отображает все сущности Docker

[Подробнее...](https://skillbox.ru/media/code/kak-rabotaet-docker-podrobnyy-gayd-ot-tekhlida/)

## Команды

### Порты публикации

Публикация портов происходит во время создания контейнера командой `docker run` с использованием флага `-p`(или `--publish`)

```bash
 docker run -d -p <HOST_PORT>:<CONTAINER_PORT> nginx
```

Любой трафик, отправленный на указанный порт на хост-компьютере, будет перенаправлен на порт внутри контейнера.

По умолчанию, когда порты контейнера сопоставлены без какого-либо конкретного адреса хоста, демон Docker привязывает опубликованные порты контейнера ко всем адресам хостов _( 0.0.0.0и [::])_.

**Это означает, что любой трафик, который достигает хост-компьютера, может получить доступ к опубликованному приложению.**

Если указать IP-адрес локального хоста _( 127.0.0.1или ::1)_ с флагом публикации, то только хост Docker и его контейнеры смогут получить доступ к опубликованному порту контейнера.

```bash
 docker run -p 127.0.0.1:8080:80 -p '[::1]:8080:80' nginx
```

Если порт хоста не указывать, Doker выберет его самостоятельно.

```bash
 docker run -p 80 nginx
```

[Подробнее...](https://docs.docker.com/engine/network/#published-ports)

Внешние подключения к контейнерам можно ограничить [Подробнее...](https://docs.docker.com/engine/network/packet-filtering-firewalls/)

### Тома и привязки

- Создание тома

  ```bash
  docker volume create <имя тома>
  ```

- Запуск контейнера и примонтирование тома:

  ```bash
  docker run -d  -v <имя тома>:/<папка контейнера> <имя контейнера>
  ```

  Все файлы, которые контейнер записывает в указанную папку будут сохраняться в указанном томе. Файлы тома сохраняются после остановки и удалений контейнера

  Один и тот же том можно прикреплять к разным контейнерам.

- Получить список всех томов:

  `docker volume ls`

Для доступа из контейнера к локальным файлам хоста можно использовать привязки.

Привязка делается к существующей папке/файлу хоста, том же создается в каталоге хранения Doker на хосте.

Для создания томов и привязок можно использовать флаг **--mount**. Он предлагает более продвинутые функции и детальный контроль, что делает его подходящим для сложных сценариев монтирования или производственных развертываний.

[Подробнее...](https://docs.docker.com/engine/storage/bind-mounts/)

### Postgres

- запустить контейнер _db_ c базой данных _postgres_ в фоновом режиме и подключить том _postgres_data_:

  ```bash
  docker run --name=db -e POSTGRES_PASSWORD=secret -d -v postgres_data:/var/lib/postgresql/data postgres
  ```

- подключиться к базе:

  ```bash
  docker exec -ti db psql -U postgres
  ```

  `\q` - выход из оболочки Postgres

- подключиться к базе и выполнить команду:

  ```bach
  docker exec -ti db psql -U postgres -c "SELECT * FROM tasks"
  ```

### Остановка и удаление контейнеров и томов

`docker stop <имя контейнера>` - остановить контейнер

`docker rm <имя контейнера>` - удалить контейнер

`docker rm -f <имя контейнера>` - остановить и удалить контейнер

`docker volume rm <имя тома>` - удалить том (он не должен быть подключен к контейнеру)

`docker volume prune` - удалить все неиспользуемые тома

## Docker Compose

- инструмент для определения и запуска многоконтейнерных приложений на основании конфигурационного файла (compose.yaml)

### Основные команды:

`docker compose build` - создать или перестроить сервисы

`docker compose up` - запустить все сервисы
`docker compose up -d` - запустить все сервисы в фоновом режиме

`docker compose down` - остановить все сервисы и удалить контейнеры

`docker compose logs` - просмотреть логи

`docker compose ps` - просмотреть список всех сервисов с их текущим статусом

`docker compose exec` - выполнить команду в работающем контейнере

`docker compose pause` - приостановить сервисы

`docker compose unpause` - возобновить работу сервисов

`docker compose stop` - остановить сервисы

`docker compose kill` - принудительно остановить контейнеры

`docker compose restart` - перезапустить контейнеры

[Подробнее...](https://docs.docker.com/reference/cli/docker/compose/)
